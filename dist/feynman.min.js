/*! feynman 2014-05-16 */
!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c=a("./particles/Electron"),d=a("./particles/Photon"),e=a("./particles/Gluon");b.exports={getParticle:function(a){switch(a){case"electron":return c;case"photon":return d;case"gluon":return e;default:return c}}}},{"./particles/Electron":11,"./particles/Gluon":12,"./particles/Photon":13}],2:[function(a,b){var c=a("./ParticleGenerator");b.exports=function(){function a(a,b,c){if("undefined"==typeof b)throw new Error("Missing canvas argument.");if("undefined"==typeof c)throw new Error("Missing data argument.");return this.canvasId=a,this.canvas=b,this.data=c,g.bind(this)(),h.bind(this)(),this}a.prototype.draw=function(){d.bind(this)(),f.bind(this)(),e.bind(this)()},a.prototype.getVertexById=function(a){var b;return this.data.vertices.forEach(function(c){c.id===a&&(b=c)}),b},a.prototype.getVerticesByDistance=function(a){var b=[];return this.data.vertices.forEach(function(c){c.distance===a&&b.push(c)}),b},a.prototype.getNumberOfLevels=function(){for(var a=0;this.getVerticesByDistance(a+1).length>0;)a++;return a},a.prototype.getControlPointById=function(a){var b;for(var c in this.data.cPoints)this.data.cPoints.hasOwnProperty(c)&&this.data.cPoints[c].forEach(function(c){c.id===a&&(b=c)});return b},a.prototype.getParticlesStartingFromPoint=function(a){return b.bind(this)("from",a)},a.prototype.getParticlesEndingInPoint=function(a){return b.bind(this)("to",a)};var b=function(a,b){var c=[];return this.data.particles.forEach(function(d){d[a]===b&&c.push(d)}),c},d=function(){this.canvas.size(this.data.width,this.data.height)},e=function(){var a=this.canvas.group();this.data.vertices.forEach(function(b){b.visible&&a.circle(6).fill("#000").translate(b.x-3,b.y-3)})},f=function(){this.data.particles.forEach(function(a){a.from=this.getVertexById(a.from)?this.getVertexById(a.from):this.getControlPointById(a.from),a.to=this.getVertexById(a.to)?this.getVertexById(a.to):this.getControlPointById(a.to),c.getParticle(a.type).draw(this.canvas,a)},this)},g=function(){for(var a in this.data.cPoints)if(this.data.cPoints.hasOwnProperty(a)){var b="left"===a||"right"===a?this.data.height:this.data.width,c="left"===a||"right"===a?this.data.width:this.data.height,d="left"===a||"right"===a?"x":"y",e="left"===a||"right"===a?"y":"x",f="right"===a||"bottom"===a?-1:1,g=1===this.data.cPoints[a].length?3:this.data.cPoints[a].length,h=.4*b/2,i=.6*b/(g-1),j=1===this.data.cPoints[a].length?1:0;this.data.cPoints[a].forEach(function(a){a[d]=-1===f?c-h:h,a[e]=j*i+h,j++})}},h=function(){k.bind(this)();for(var a=this.data.cPoints.left.length>0?this.data.width:this.data.height,b=this.data.cPoints.left.length>0?this.data.height:this.data.width,c=this.data.cPoints.left.length>0?"x":"y",d=this.data.cPoints.left.length>0?"y":"x",e=.3*a,f=.3*b,g=.4*a,h=.4*b,i=1;this.getVerticesByDistance(i).length>0;){var l=this.getVerticesByDistance(i),m=1===this.getNumberOfLevels()?2:this.getNumberOfLevels()-1,n=1===l.length?2:l.length-1,o=g/m,p=h/n,q=1===l.length?1:0,r=1===this.getNumberOfLevels()?0:1;l.forEach(function(a){a[c]=o*(i-r)+e,a[d]=p*q+f,q++}),i++}j.bind(this)()},i=function(){var a={};return this.data.particles.forEach(function(b){a[b.to]=[],a[b.from]=[]}),this.data.particles.forEach(function(b){0!==b.tension&&(a[b.to].push(b.from),a[b.from].push(b.to))}),a},j=function(){var a=i.bind(this)(),b=this.data.cPoints.left.length>0?"left":"top",c=this,d=[],e=function(b,f,g){var h=c.getVertexById(b),i=g;if(h){if(h.sub)d.push(b);else{var j=1;d.forEach(function(a){var e=c.getVertexById(a);if(!e.start){var f=c.getVertexById(i)?c.getVertexById(i):c.getControlPointById(i),h=c.getVertexById(b);e.start=e.start?e.start:g,e.end=e.end?e.end:b;var k=Math.abs(h.x-f.x)/(d.length+1),l=Math.abs(h.y-f.y)/(d.length+1);e.x=f.x+k*j,e.y=f.y+l*j,j++}}),d=[],i=b}var k=a[b].filter(function(a){return a!==f&&(c.getControlPointById(a)||c.getVertexById(a)&&(!h.distance||!c.getVertexById(a).distance||c.getVertexById(a).distance>h.distance||c.getVertexById(a).sub))});k.forEach(function(a){e(a,b,i)})}else{var l=1;d.forEach(function(a){var e=c.getVertexById(a);if(!e.start){var f=c.getVertexById(i)?c.getVertexById(i):c.getControlPointById(i),h=c.getControlPointById(b);e.start=e.start?e.start:g,e.end=e.end?e.end:b;var j=Math.abs(h.x-f.x)/(d.length+1),k=Math.abs(h.y-f.y)/(d.length+1);e.x=f.x+j*l,e.y=f.y+k*l,l++}}),d=[]}};this.data.cPoints[b].forEach(function(b){a[b.id]&&a[b.id].forEach(function(a){e(a,b.id,b.id)})})},k=function(){var a=i.bind(this)(),b=this,c=function(d,e,f){var g=b.getVertexById(d);if(g){var h=1;g.sub?h=0:g.distance=g.distance?Math.min(g.distance,e):e;var i=a[d].filter(function(a){return a!==f&&b.getVertexById(a)&&(!b.getVertexById(a).distance||b.getVertexById(a).distance>g.distance)});i.forEach(function(a){c(a,e+h,d)})}},d=this.data.cPoints.left.length>0?"left":"top";this.data.cPoints[d].forEach(function(b){a[b.id]&&a[b.id].forEach(function(a){c(a,1)})})};return a}()},{"./ParticleGenerator":1}],3:[function(a,b){var c=a("./helpers/Klass");b.exports={getStructure:function(){return c.__clone({title:"",width:200,height:150,thickness:"thick",particles:[],vertices:[],cPoints:{left:[],right:[],top:[],bottom:[]}})}}},{"./helpers/Klass":6}],4:[function(a,b){b.exports={merge:function(a,b){for(var c in b)if(b.hasOwnProperty(c))try{a[c]=b[c].constructor===Object?this.merge(a[c],b[c]):b[c]&&a[c]?b[c]:a[c]}catch(d){a[c]=b[c]}return a}}},{}],5:[function(a,b){var c=Math.PI,d=function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.exports={normalizePathString:function(){for(var a,b="",c=0,d=arguments.length;d>c;c++)a=arguments[c],b+=" "+("number"!=typeof a?a:a.toFixed(3).replace(/(.\d*?)0+$/,"$1").replace(/\.$/,""));var e=b.trim();return e.replace(/ ?, ?/g,",")},getCoordinatesInBezier:function(a,b,c,d,e,f){var g=Math.atan2(d-b,c-a);return this.normalizePathString(e*Math.cos(g)-f*Math.sin(g)+a,",",e*Math.sin(g)+f*Math.cos(g)+b)},line:function(a,b,c){for(var e=["M"],f=Math.floor(c/b),g=c-b*f+.1,h=0;f>=h;h++)for(var i,j=0,k=a.length;k>j;j++)if(i=a[j],d(i)){if(!(f>h||i[0]<g))break;e.push(this.normalizePathString(i[0]+b*h,",",i[1]))}else e.push(i);return e.join(" ").replace(/\s[A-Z][^A-Z]*$/,"")},arc:function(a,b,e,f,g){for(var h=g?g:2,i=.25*h,j=Math.acos(-.5/i),k=-2*Math.asin(e/(i*f)),l=[],m=["M","0,0"],n=0;(c-2*j)/k>=n;n++)l.push([f*(i*Math.cos(k*n+j)+.5),f*(i*Math.sin(k*n+j)-Math.sqrt(i*i-.25))]);for(var o,p=0,q=l.length-1;q>p;p++){o="photon"===a?b[p%2]:b;for(var r,s=0,t=o.length;t>s;s++)r=o[s],m.push(d(r)?this.getCoordinatesInBezier(l[p][0],l[p][1],l[p+1][0],l[p+1][1],r[0],r[1]):r)}return m.join(" ").replace(/\s[A-Z]$/,"")},loop:function(a,b,e,f){for(var g=!0,h=2*Math.asin(2*e/f),i=2*c/h,j=[],k=g?-.5:.5,l=["M","gluon"===a?k+",0":"0,"+k],m=-.1,n=f;Math.floor(i)%4||i-Math.floor(i)>.1;m+=.001)f=(1+m)*n,h=2*Math.asin(2*e/f),i=2*c/h;for(var o=0;i>=o;o++){var p=.5*f*(1-Math.cos(h*o)),q=.5*f*Math.sin(h*o);j.push([p,q])}for(var r,s=0,t=j.length-1;t>s;s++){r="photon"===a?b[s%2]:b;for(var u,v=0,w=r.length;w>v;v++)u=r[v],l.push(d(u)?this.getCoordinatesInBezier(j[s][0],j[s][1],j[s+1][0],j[s+1][1],u[0],u[1]):u)}return l.join(" ").replace(/\s[A-Z]$/,"")+" Z"}}},{}],6:[function(a,b){var c={}.hasOwnProperty;b.exports={__extends:function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},__clone:function(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}}},{}],7:[function(a,b){b.exports={getAngle:function(a,b,c){var d=c?1:180/Math.PI,e=b.x-a.x,f=b.y-a.y;return Math.atan2(f,e)*d},getDistance:function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.sqrt(c*c+d*d)},getPositionValues:function(a,b){var c=this.getAngle(a,b),d=this.getDistance(a,b);return{x:a.x,y:a.y,r:c,l:d}}}},{}],8:[function(a,b){var c=a("./parsers/ParserFactory"),d=a("./Stage");b.exports=function(){var a=function(){return this};return a.prototype.draw=function(a,b){if("undefined"==typeof a)throw new Error("Missing canvas#id argument!");if("undefined"==typeof b)throw new Error("Missing data argument!");var e=new SVG(a),f=c.getParser(b),g=f.parse(),h=new d(a,e,g);return h.draw(),this},window.Feynman=a,a}()},{"./Stage":2,"./parsers/ParserFactory":10}],9:[function(a,b){{var c=a("./../StageStructure");a("./../helpers/Klass")}b.exports=function(){function a(a){if("undefined"==typeof a)throw new Error("No data given.");return this.raw=a,b=c.getStructure(),this}var b;a.prototype.parse=function(){return this.raw.title&&(b.title=this.raw.title),this.raw.width&&(b.width=this.raw.width),this.raw.height&&(b.height=this.raw.height),this.raw.diagram&&this.raw.diagram.forEach(function(a){d(a)}),b};var d=function(a){var b=a.match(/\w+/g)[0],c=a.match(/(\{\w+([^\}\{]|\d?)+?\})/g),d=v(u(c));void 0!==b&&void 0!==A[b]&&A[b](d)},e=function(a){for(var c=0;a[1][c+1];){var d=a[1][c],e=a[1][c+1],f="p"+(b.particles.length+1);t(d),t(e);var g=x(a[0].slice(1)),h=0,i=0;g.right&&(h="string"==typeof g.right?parseFloat(g.right):1),g.left&&(i="string"==typeof g.left?parseFloat(g.left):1);var j={id:f,from:d,to:e,type:a[0][0],label:g.label,labelSide:g.side,labelDistance:g.dist,tension:parseFloat(g.tension),right:h,left:i,tag:g.tag,color:g.foreground,bgColor:g.background,penWidth:g.width};b.particles.push(j),c++}},f=function(a,c){c[0].forEach(function(c){z(c)||b.cPoints[a].push({id:c,x:0,y:0,side:a})})},g=function(a){f("right",a)},h=function(a){f("left",a)},i=function(a){f("top",a)},j=function(a){f("bottom",a)},k=function(a,b){for(var c=parseInt(b[0],10),d=[],e=1,g="left"===a||"top"===a?"i":"o";c>=e;)d.push(g+e),e++;f(a,[d])},l=function(a){k("right",a)},m=function(a){k("left",a)},n=function(a){k("top",a)},o=function(a){k("bottom",a)},p=function(a){a[0].forEach(function(a){var b=y(a);b&&(b.visible=!0)})},q=function(a){("thick"===a[0][0]||"thin"===a[0][0])&&(b.thickness=a[0][0])},r=function(a){return"v"===a[0]},s=function(a){return/\*/.test(a)},t=function(a){if(r(a)&&!y(a)){var c={id:a};s(a)&&(c.sub=!0),b.vertices.push(c)}},u=function(a){var b=/\{|\}/g;return a.map(function(a){return a.replace(b,"")})},v=function(a){var b=[];return a.forEach(function(a){var c=a.split(",");c=w(c),b.push(c)}),b},w=function(a){var b=[];return a.forEach(function(a){var c=a,d=/(\w+)\=(\S+)/g,e=d.exec(c);if(e&&e.length>2){var f=e[1],g=e[2];c={},c[f]=g}b.push(c)}),b},x=function(a){var b={};return a&&0===a.length?b:(a.forEach(function(a){if("string"==typeof a&&(b[a]=!0),"object"==typeof a){var c=Object.keys(a)[0];b[c]="undefined"==typeof a[c]?!0:a[c]}}),b)},y=function(a){var c;return b.vertices.forEach(function(b){b.id===a&&(c=b)}),c},z=function(a){var c;for(var d in b.cPoints)b.cPoints.hasOwnProperty(d)&&b.cPoints[d].forEach(function(b){b.id===a&&(c=b)});return c},A={fmf:e,fmfbottom:j,fmfbottomn:o,fmfdot:p,fmfleft:h,fmfleftn:m,fmfpen:q,fmfright:g,fmfrightn:l,fmftop:i,fmftopn:n};return a}()},{"./../StageStructure":3,"./../helpers/Klass":6}],10:[function(a,b){var c=a("./LatexParser");b.exports={getParser:function(a){switch(a.lang){default:return new c(a)}}}},{"./LatexParser":9}],11:[function(a,b){var c=a("./../helpers/Point"),d=(a("./../helpers/Array"),a("./../helpers/Bezier"));b.exports={_defaults:{type:"electron",from:{x:0,y:0},to:{x:0,y:0},label:"",right:!1,left:!1,tension:1,tag:"",color:"#000",bgColor:null,penWidth:2,labelSide:"right",labelDistance:10},draw:function(a,b){if(a){var d=a.group(),e=c.getPositionValues(b.from,b.to),f="line",g=!0,h=2;return(b.left||b.right)&&(f="arc",g=0!==b.right?-1:1,h=0!==b.right?b.right:b.left),"plain"!==b.type&&this._drawArrow(d,e.l,b.color?b.color:this._defaults.color,"antifermion"===b.type),d.path(this.getPath(f,b,h)).fill("none").stroke({width:b.penWidth?b.penWidth:this._defaults.penWidth,color:b.color?b.color:this._defaults.color}).scale(1,g),d.transform({cx:e.x,cy:e.y,rotation:e.r,x:e.x,y:e.y}),d}},getPath:function(a,b,e){var f=c.getPositionValues(b.from,b.to),g=f.l,h=[[1,1],[2,1]];switch(a){case"line":return d.line(h,1,g);case"arc":return d.arc("electron",h,1,g,e);case"loop":return d.loop("electron",h,1,g);default:return d.line(h,1,g)}},_drawArrow:function(a,b,c,d){var e=d?-1:1,f=b/2+7*e,g=0,h=b/2-7*e,i=3.5,j=b/2-7*e,k=-3.5,l=""+f+","+g+" "+h+","+i+" "+j+","+k;a.polygon(l).fill(c)}}},{"./../helpers/Array":4,"./../helpers/Bezier":5,"./../helpers/Point":7}],12:[function(a,b){var c=a("./../helpers/Point"),d=(a("./../helpers/Array"),a("./../helpers/Bezier"));b.exports={_defaults:{type:"gluon",from:{x:0,y:0},to:{x:0,y:0},label:"",right:!1,left:!1,tension:1,tag:"",color:"#009933",bgColor:null,penWidth:2,labelSide:"right",labelDistance:10},draw:function(a,b){if(a){var d=a.group(),e=c.getPositionValues(b.from,b.to),f="line",g=!0,h=2;return(b.left||b.right)&&(f="arc",g=0!==b.right?-1:1,h=0!==b.right?b.right:b.left),d.path(this.getPath(f,b,h)).fill("none").stroke({width:b.penWidth?b.penWidth:this._defaults.penWidth,color:b.color?b.color:this._defaults.color}).scale(1,g),d.transform({cx:e.x,cy:e.y,rotation:e.r,x:e.x,y:e.y}),d}},getPath:function(a,b,e){var f=c.getPositionValues(b.from,b.to),g=f.l+(5-f.l%5),h={width:13,height:13,factor:.75,percent:.6,scale:1.15},i=.55191502,j=h.height*h.factor,k=h.width*h.percent,l=h.height*(h.factor-.5),m=h.width*(1-h.percent),n=!0,o=n?[[0,0],"A "+j+" "+k,0,0,1,[j,k],"A "+l+" "+m,0,1,1,[j-2*l,k],"A "+j+" "+k,0,0,1]:[[0,0],"A "+j+" "+k,0,0,0,[j,-k],"A "+l+" "+m,0,1,0,[j-2*l,-k],"A "+j+" "+k,0,0,0];j=n?j:h.scale*j;var p=j/Math.pow(g,.6),q=n?["C",[i*j,p],[j,k-i*k],[j,k],"C",[j,k+i*m],[j-l+i*l,k+m],[j-l,k+m],"S",[j-2*l,k+i*m],[j-2*l,k],"C",[j-2*l,k-i*k],[2*(j-l)-i*j,0],[2*(j-l),-p]]:["C",[i*j,p],[j,-k+i*k],[j,-k],"C",[j,-k-i*m],[j-l+i*l,-k-m],[j-l,-k-m],"S",[j-2*l,-k-i*m],[j-2*l,-k],"C",[j-2*l,-k+i*k],[2*(j-l)-i*j,0],[2*(j-l),-p]];switch(a){case"line":return d.line(o,h.height,g);case"arc":return d.arc("gluon",q,j-l,g,e);case"loop":return d.loop("gluon",q,j-l,g);default:return d.line(o,h.height,g)}}}},{"./../helpers/Array":4,"./../helpers/Bezier":5,"./../helpers/Point":7}],13:[function(a,b){var c=a("./../helpers/Point"),d=(a("./../helpers/Array"),a("./../helpers/Bezier"));b.exports={_defaults:{type:"photon",from:{x:0,y:0},to:{x:0,y:0},label:"",right:!1,left:!1,tension:1,tag:"",color:"#0066FF",bgColor:null,penWidth:2,labelSide:"right",labelDistance:10},draw:function(a,b){if(a){var d=a.group(),e=c.getPositionValues(b.to,b.from),f="line",g=1,h=2;return(b.left||b.right)&&(f="arc",g=0!==b.right?-1:1,h=0!==b.right?b.right:b.left),d.path(this.getPath(f,b,h)).fill("none").stroke({width:b.penWidth?b.penWidth:this._defaults.penWidth,color:b.color?b.color:this._defaults.color}).scale(1,g),d.transform({cx:e.x,cy:e.y,rotation:e.r,x:e.x,y:e.y}),d}},getPath:function(a,b,e){var f=c.getPositionValues(b.from,b.to),g=f.l,h=Math.PI,i=.51128733,j=2,k=.5*i*j,l=3,m=2*l/h,n=i*l/h,o=!0,p=o?[[0,0],"C",[n,-k],[m,-j],[l,-j],"S",[2*l-n,-k],[2*l,0],"S",[2*l+m,j],[3*l,j],"S",[4*l-n,k]]:[[0,0],"C",[n,k],[m,j],[l,j],"S",[2*l-n,k],[2*l,0],"S",[2*l+m,-j],[3*l,-j],"S",[4*l-n,-k]],q=o?[["C",[n,-k],[m,-j],[l,-j],"S",[2*l-n,-k],[2*l+.5,0]],["C",[n,k],[m,j],[l,j],"S",[2*l-n,-k],[2*l-.5,0]]]:[["C",[n,k],[m,j],[l,j],"S",[2*l-n,k],[2*l-.5,0]],["C",[n,-k],[m,-j],[l,-j],"S",[2*l-n,-k],[2*l+.5,0]]];switch(a){case"line":return d.line(p,4*l,g);case"arc":return d.arc("photon",q,l,g,e);case"loop":return d.loop("photon",q,l,g);default:return d.line(p,4*l,g)}}}},{"./../helpers/Array":4,"./../helpers/Bezier":5,"./../helpers/Point":7}]},{},[8]);